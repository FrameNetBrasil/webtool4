<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Interface</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .timeline-container {
            border: 1px solid #ccc;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-ruler {
            position: sticky;
            top: 0;
            z-index: 100;
            height: 30px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #666;
            overflow: hidden;
        }

        .ruler-content {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            padding-left: 150px; /* Offset for layer labels */
        }

        .ruler-tick {
            position: absolute;
            height: 20px;
            border-left: 1px solid #999;
            font-size: 10px;
            padding-left: 2px;
            display: flex;
            align-items: center;
        }

        .ruler-tick.major {
            border-left: 2px solid #333;
            font-weight: bold;
        }

        .timeline-content {
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
        }

        .timeline-inner {
            position: relative;
            min-width: 100%;
        }

        .layer {
            position: relative;
            border-bottom: 1px solid #eee;
            display: flex;
        }

        .layer-label {
            position: sticky;
            left: 0;
            z-index: 10;
            width: 150px;
            background-color: #e9ecef;
            border-right: 1px solid #ddd;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            box-sizing: border-box;
        }

        .layer-objects {
            position: relative;
            flex: 1;
            min-height: 24px;
        }

        .timeline-object {
            position: absolute;
            height: 24px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0 4px;
            font-size: 10px;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-sizing: border-box;
            min-width: 16px;
            transition: opacity 0.2s, transform 0.2s;
        }

        .timeline-object:hover {
            opacity: 0.8;
            transform: scale(1.02);
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .timeline-info {
            position: sticky;
            bottom: 0;
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
            padding: 8px;
            font-size: 12px;
            color: #666;
            z-index: 100;
        }

        .loading {
            padding: 20px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="timeline-container">
        <div class="timeline-ruler">
            <div class="ruler-content" id="rulerContent">
                <!-- Ruler ticks will be generated here -->
            </div>
        </div>

        <div class="timeline-content" id="timelineContent">
            <div class="timeline-inner" id="timelineInner">
                <div class="loading" id="loading">Loading timeline data...</div>
            </div>
        </div>

        <div class="timeline-info" id="timelineInfo">
            Ready to load timeline data
        </div>
    </div>

    <script>
        let timelineData = null;
        let minFrame = 0;
        let maxFrame = 0;
        let timelineWidth = 0;
        const FRAME_TO_PX = 1; // 1 frame = 1px
        const MIN_OBJECT_WIDTH = 16; // minimum width in pixels
        const OBJECT_HEIGHT = 24; // height in pixels

        // Load and parse the timeline data
        async function loadTimelineData() {
            try {
                const response = await fetch('/deixis_layers.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonText = await response.text();
                timelineData = JSON.parse(jsonText);

                // Calculate frame range
                calculateFrameRange();

                // Generate timeline
                generateTimeline();

                // Setup event listeners
                setupEventListeners();

                updateTimelineInfo();

            } catch (error) {
                console.error('Error loading timeline data:', error);
                document.getElementById('loading').textContent = 'Error loading timeline data: ' + error.message;
            }
        }

        function calculateFrameRange() {
            minFrame = Infinity;
            maxFrame = -Infinity;

            timelineData.forEach(layer => {
                layer.objects.forEach(obj => {
                    minFrame = Math.min(minFrame, obj.startFrame);
                    maxFrame = Math.max(maxFrame, obj.endFrame);
                });
            });

            // Add some padding
            minFrame = Math.max(0, minFrame - 100);
            maxFrame = maxFrame + 100;

            timelineWidth = (maxFrame - minFrame) * FRAME_TO_PX;
        }

        function generateTimeline() {
            const timelineInner = document.getElementById('timelineInner');
            timelineInner.innerHTML = '';

            // Set timeline width
            timelineInner.style.width = (timelineWidth + 150) + 'px';

            // Generate layers
            timelineData.forEach((layer, layerIndex) => {
                const layerDiv = createLayer(layer, layerIndex);
                timelineInner.appendChild(layerDiv);
            });

            // Generate ruler
            generateRuler();
        }

        function createLayer(layer, layerIndex) {
            const layerDiv = document.createElement('div');
            layerDiv.className = 'layer';
            layerDiv.style.height = (layer.objects.length * OBJECT_HEIGHT) + 'px';

            // Layer label
            const labelDiv = document.createElement('div');
            labelDiv.className = 'layer-label';
            labelDiv.style.height = (layer.objects.length * OBJECT_HEIGHT) + 'px';
            labelDiv.textContent = layer.layer;
            labelDiv.title = layer.layer;

            // Layer objects container
            const objectsDiv = document.createElement('div');
            objectsDiv.className = 'layer-objects';
            objectsDiv.style.width = timelineWidth + 'px';

            // Create objects
            layer.objects.forEach((obj, objIndex) => {
                const objectDiv = createTimelineObject(obj, objIndex, layerIndex);
                objectsDiv.appendChild(objectDiv);
            });

            layerDiv.appendChild(labelDiv);
            layerDiv.appendChild(objectsDiv);

            return layerDiv;
        }

        function createTimelineObject(obj, objIndex, layerIndex) {
            const objectDiv = document.createElement('div');
            objectDiv.className = 'timeline-object';

            // Calculate position and dimensions
            const startPos = (obj.startFrame - minFrame) * FRAME_TO_PX;
            const duration = obj.endFrame - obj.startFrame;
            const width = Math.max(MIN_OBJECT_WIDTH, duration * FRAME_TO_PX);

            // Position
            objectDiv.style.left = startPos + 'px';
            objectDiv.style.top = (objIndex * OBJECT_HEIGHT) + 'px';
            objectDiv.style.width = width + 'px';

            // Color
            const bgColor = obj.bgColorGL || '#999999';
            objectDiv.style.backgroundColor = bgColor;

            // Text
            const label = obj.gl || obj.luName || obj.name || `Object ${objIndex + 1}`;
            objectDiv.textContent = label;
            objectDiv.title = `${label}\nFrames: ${obj.startFrame}-${obj.endFrame}\nDuration: ${duration} frames`;

            // Data attributes for event handling
            objectDiv.dataset.layerIndex = layerIndex;
            objectDiv.dataset.objectIndex = objIndex;
            objectDiv.dataset.startFrame = obj.startFrame;
            objectDiv.dataset.endFrame = obj.endFrame;

            // Click event
            objectDiv.addEventListener('click', function(e) {
                handleObjectClick(obj, layerIndex, objIndex, e);
            });

            return objectDiv;
        }

        function generateRuler() {
            const rulerContent = document.getElementById('rulerContent');
            rulerContent.innerHTML = '';

            // Set ruler width
            rulerContent.style.width = timelineWidth + 'px';

            // Generate ticks every 1000 frames (major) and 100 frames (minor)
            for (let frame = minFrame; frame <= maxFrame; frame += 100) {
                const tick = document.createElement('div');
                tick.className = 'ruler-tick';

                const isMajor = frame % 1000 === 0;
                if (isMajor) {
                    tick.classList.add('major');
                    tick.textContent = frame.toLocaleString();
                }

                tick.style.left = ((frame - minFrame) * FRAME_TO_PX) + 'px';
                rulerContent.appendChild(tick);
            }
        }

        function setupEventListeners() {
            const timelineContent = document.getElementById('timelineContent');

            // Update ruler on scroll
            timelineContent.addEventListener('scroll', updateRulerOnScroll);
        }

        function updateRulerOnScroll() {
            const timelineContent = document.getElementById('timelineContent');
            const scrollLeft = timelineContent.scrollLeft;
            const viewportWidth = timelineContent.clientWidth;

            const startFrame = Math.floor(scrollLeft / FRAME_TO_PX) + minFrame;
            const endFrame = Math.floor((scrollLeft + viewportWidth) / FRAME_TO_PX) + minFrame;

            updateTimelineInfo(`Viewing frames: ${startFrame.toLocaleString()} - ${endFrame.toLocaleString()}`);
        }

        function updateTimelineInfo(message = null) {
            const info = document.getElementById('timelineInfo');
            if (message) {
                info.textContent = message;
            } else {
                const totalLayers = timelineData ? timelineData.length : 0;
                const totalObjects = timelineData ? timelineData.reduce((sum, layer) => sum + layer.objects.length, 0) : 0;
                info.textContent = `Timeline: ${totalLayers} layers, ${totalObjects} objects, frames ${minFrame.toLocaleString()}-${maxFrame.toLocaleString()}`;
            }
        }

        function handleObjectClick(obj, layerIndex, objIndex, event) {
            console.log('Object clicked:', {
                layer: timelineData[layerIndex].layer,
                layerIndex,
                objectIndex: objIndex,
                object: obj,
                frameRange: `${obj.startFrame}-${obj.endFrame}`,
                duration: obj.endFrame - obj.startFrame
            });

            // Highlight clicked object temporarily
            const clickedElement = event.target;
            const originalOpacity = clickedElement.style.opacity;
            clickedElement.style.opacity = '0.6';
            setTimeout(() => {
                clickedElement.style.opacity = originalOpacity;
            }, 200);

            // Update info
            updateTimelineInfo(`Clicked: ${obj.gl || 'Object'} (${obj.startFrame}-${obj.endFrame})`);

            // You can add more click handling logic here
            // For example, navigate to specific frame, show details panel, etc.
        }

        // Initialize the timeline
        loadTimelineData();
    </script>
</body>
</html>
